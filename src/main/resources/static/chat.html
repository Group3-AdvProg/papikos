<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Papikos • Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        :root { --bs-primary:#7065F0; }

        .btn-primary {
            background: var(--bs-primary) !important;
            border-color: var(--bs-primary) !important;
            color:#fff !important;
        }
        .btn-primary:hover {
            background:#5e54d8 !important;
            border-color:#5e54d8 !important;
        }

        body     { font-family:'Segoe UI', sans-serif; background:#f9f9ff; }
        #rooms   { max-height:70vh; overflow:auto; }
        #messages{
            height:60vh; overflow-y:auto;
            background:#fff; border-radius:.5rem;
        }
        #messages .me            { text-align:right; }
        #messages .me .bubble    { background:var(--bs-primary); color:#fff; }
        #messages .other .bubble { background:#eef0ff; }

        .bubble{
            display:inline-block; padding:.5rem .8rem;
            border-radius:1rem; max-width:80%;
        }
        .meta    { font-size:.75rem; color:#6c757d; }
        .actions {
            font-size:.8rem; margin-left:.25rem; cursor:pointer; opacity:.7;
        }
        .actions:hover { opacity:1; }
    </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container py-4">
    <div class="row g-4">
        <!-- ▸ sidebar ------------------------------------------------------ -->
        <div class="col-md-4">
            <h5 class="fw-bold mb-3">Rooms</h5>

            <!-- hidden by default; “ROLE_TENANT” removes d-none -->
            <div id="newRoomWrapper" class="d-grid gap-2 mb-3 d-none">
                <button class="btn btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#newRoomModal">
                    ➕ New Room
                </button>
            </div>

            <ul class="list-group" id="rooms"></ul>
        </div>

        <!-- ▸ chat panel ---------------------------------------------------- -->
        <div class="col-md-8 d-flex flex-column">
            <div id="messages" class="p-3 flex-grow-1 border mb-2">
                <p id="emptyHint" class="text-muted m-0">
                    Select a room to begin chatting.
                </p>
            </div>

            <form id="msgForm" class="input-group">
                <input id="msgInput" class="form-control"
                       placeholder="Type a message…" required />
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-send-fill"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- ▸ modal --------------------------------------------------------------- -->
<div class="modal fade" id="newRoomModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="newRoomForm">
            <div class="modal-header">
                <h5 class="modal-title">Create Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Landlord Email</label>
                    <input type="email" name="landlordEmail"
                           class="form-control" required />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" type="submit">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- ▸ deps --------------------------------------------------------------- -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="/js/navbarLoader.js"></script>

<script>
    /* ─── helpers ─────────────────────────────────────────────────────────── */
    function token()        { return sessionStorage.getItem("token"); }
    function parseJwt(t)    { try { return JSON.parse(atob(t.split('.')[1])); }
    catch { return {}; } }
    function currentEmail() { return parseJwt(token()||"").sub || null; }

    async function api(url, init={}) {
        init.headers = { ...(init.headers||{}), Authorization:"Bearer "+token() };
        const res = await fetch(url, init);
        if (res.status===401) { location.href="/login.html"; return null; }
        return res;
    }

    /* ─── boot ────────────────────────────────────────────────────────────── */
    let stomp, roomId;

    document.addEventListener("DOMContentLoaded", () => {
        const jwt   = parseJwt(token()||"");
        const roles = jwt.authorities
            ? jwt.authorities.map(a=>a.authority)
            : jwt.roles || [];

        /* show create-room only for tenants */
        const newRoomWrapper = document.getElementById("newRoomWrapper");
        if (roles.includes("ROLE_TENANT"))
            newRoomWrapper.classList.remove("d-none");

        initChat();
    });

    /* ─── chat logic ──────────────────────────────────────────────────────── */
    async function initChat() {
        roomId = new URLSearchParams(location.search).get("roomId");

        await loadRooms();               // build sidebar first

        if (roomId) {                    // connect *only* if a room is chosen
            document.getElementById("emptyHint")?.remove();
            connectWS();
            setupSend();
            await loadHistory();
        }
        setupRoomCreation();
    }

    /* sidebar ---------------------------------------------------------------- */
    async function loadRooms() {
        const res = await api("/api/chat/rooms");
        if (!res) return;
        const rooms = await res.json();
        const ul    = document.getElementById("rooms");
        ul.innerHTML = rooms.length ? "" :
            '<li class="list-group-item">No rooms yet</li>';

        /* auto-jump to first room (uncomment if that UX is preferred) */
        // if (!roomId && rooms.length) {
        //     location.search = '?roomId=' + rooms[0].id;
        //     return;
        // }

        rooms.forEach(r=>{
            const youAreTenant = r.tenant?.email === currentEmail();
            const other  = youAreTenant ? r.landlord : r.tenant;
            const label  = other?.fullName || other?.email || "Unknown";

            ul.insertAdjacentHTML("beforeend", `
            <li class="list-group-item ${r.id==roomId?'active':''}">
                <a href="?roomId=${r.id}"
                   class="${r.id==roomId?'text-white':'text-primary fw-semibold'} text-decoration-none">
                    ${label}
                </a>
            </li>`);
        });
    }

    /* websocket -------------------------------------------------------------- */
    function connectWS() {
        stomp = Stomp.over(new SockJS("/ws"));
        stomp.connect({Authorization:"Bearer "+token()}, ()=>{
            stomp.subscribe(`/topic/room/${roomId}`, msg =>
                showMessage(JSON.parse(msg.body)) );
        });
    }

    /* history ---------------------------------------------------------------- */
    async function loadHistory() {
        const res = await api(`/api/chat/rooms/${roomId}/messages`);
        if (!res) return;
        (await res.json()).forEach(showMessage);
        scrollBottom();
    }

    /* render ----------------------------------------------------------------- */
    function showMessage(m) {
        const mine = m.sender?.email === currentEmail();
        const div  = document.getElementById("messages");
        const t    = new Date(m.timestamp||Date.now())
            .toLocaleTimeString("id-ID",{hour:'2-digit',minute:'2-digit'});

        div.insertAdjacentHTML("beforeend", `
        <div data-id="${m.id||''}" class="${mine?'me':'other'} mb-2">
            <span class="bubble">${m.content}</span>
            ${mine ? editIcons(m.id) : ''}
            <br />
            <span class="meta">${mine?'You':m.sender?.email||'Anon'} • ${t}</span>
        </div>`);
    }

    function scrollBottom() {
        const m = document.getElementById("messages");
        m.scrollTop = m.scrollHeight;
    }

    /* send ------------------------------------------------------------------- */
    function setupSend() {
        document.getElementById("msgForm").addEventListener("submit", e=>{
            e.preventDefault();
            if (!stomp?.connected) return;

            const content = document.getElementById("msgInput").value.trim();
            if (!content) return;

            stomp.send(`/app/chat/${roomId}/sendMessage`, {},
                JSON.stringify({ senderEmail:currentEmail(), type:"CHAT", content }));
            document.getElementById("msgInput").value="";
        });
    }

    /* edit/delete ------------------------------------------------------------ */
    function editIcons(id){
        return `
        <i class="bi bi-pencil-square actions text-warning"
           title="Edit"   onclick="editMsg(${id})"></i>
        <i class="bi bi-trash-fill actions text-danger"
           title="Delete" onclick="deleteMsg(${id})"></i>`;
    }
    window.editMsg = async id => {
        const node   = document.querySelector(`[data-id='${id}']`);
        const bubble = node.querySelector('.bubble');
        const oldTxt = bubble.textContent;
        const fresh  = prompt("Edit message:", oldTxt);
        if (!fresh || fresh.trim()===oldTxt) return;

        const ok = await api(`/api/chat/rooms/${roomId}/messages/${id}`,{
            method:"PUT",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({content:fresh.trim()})
        });
        if (ok?.ok) bubble.textContent=fresh.trim();
        else alert("Failed to update");
    };
    window.deleteMsg = async id => {
        if (!confirm("Delete this message?")) return;
        const ok = await api(`/api/chat/rooms/${roomId}/messages/${id}`,{
            method:"DELETE"});
        if (ok?.ok) document.querySelector(`[data-id='${id}']`).remove();
        else alert("Delete failed");
    };

    /* create room ------------------------------------------------------------ */
    function setupRoomCreation(){
        document.getElementById("newRoomForm")
            .addEventListener("submit",async e=>{
                e.preventDefault();
                const landlordEmail =
                    e.target.elements["landlordEmail"].value.trim();
                if (!landlordEmail) return alert("Enter landlord email!");

                const res = await api("/api/chat/rooms",{
                    method:"POST",
                    headers:{"Content-Type":"application/json"},
                    body:JSON.stringify({landlordEmail})
                });
                if (res?.ok){
                    bootstrap.Modal.getInstance(
                        document.getElementById("newRoomModal")).hide();
                    loadRooms();
                } else alert("Failed to create room");
            });
    }

    window.addEventListener("DOMContentLoaded", () => {
        loadNavbar();
    });
</script>
</body>
</html>
