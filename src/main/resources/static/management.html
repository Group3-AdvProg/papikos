<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Manage Boarding Houses</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        :root {
            --bs-primary: #7065F0;
        }

        .text-primary {
            color: var(--bs-primary) !important;
        }

        .bg-primary {
            background-color: var(--bs-primary) !important;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f9f9ff;
        }

        .btn-primary {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }

        .btn-outline-primary {
            color: var(--bs-primary);
            border-color: var(--bs-primary);
        }

        .btn-outline-primary:hover {
            background-color: var(--bs-primary);
            color: white;
        }

        .card-clickable {
            text-decoration: none;
            color: inherit;
        }

        .card-clickable:hover {
            opacity: 0.9;
        }

        .card-body * {
            pointer-events: none;
        }

        .action-buttons {
            pointer-events: auto;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-white shadow-sm w-100">
    <div class="container">
        <a class="navbar-brand fw-bold text-primary" href="#">Papikos</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/management.html">My Houses</a></li>

                <li class="nav-item dropdown" id="user-dropdown" style="display: none;">
                    <a class="btn btn-outline-primary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <span id="user-email">User</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="logout-btn">Logout</a></li>
                    </ul>
                </li>
                <li class="nav-item" id="login-btn"><a class="btn btn-outline-primary me-2" href="/login.html">Login</a></li>
                <li class="nav-item" id="signup-btn"><a class="btn btn-primary" href="/register.html">Sign up</a></li>
            </ul>
        </div>
    </div>
</nav>
<div class="container py-4">
    <div class="alert alert-primary d-flex justify-content-between align-items-center">
        <div>
            üëã <span id="welcome-email"></span>
            üí∞ Balance: Rp <span id="wallet-balance">...</span>
        </div>
        <div class="d-flex gap-2">
            <a href="/wallet-history.html" class="btn btn-outline-secondary">Transaction History</a>
            <a href="/wallet-topup.html" class="btn btn-outline-success">Top Up</a>
            <a href="/wallet-pay.html" class="btn btn-outline-primary">Pay Rent</a>
        </div>
    </div>
</div>
<div class="container py-4">
    <h1 class="fw-bold">My Boarding Houses</h1>

    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createHouseModal">
        ‚ûï Add New House
    </button>

    <div class="row row-cols-1 row-cols-md-3 g-4" id="houseContainer"></div>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createHouseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="createHouseForm">
            <div class="modal-header">
                <h5 class="modal-title">Add New House</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2"><input class="form-control" name="name" placeholder="Name" required /></div>
                <div class="mb-2"><input class="form-control" name="address" placeholder="Address" required /></div>
                <div class="mb-2"><input class="form-control" name="description" placeholder="Description" required /></div>
                <div class="mb-2"><input class="form-control" name="numberOfRooms" type="number" placeholder="Number of Rooms" required /></div>
                <div class="mb-2"><input class="form-control" name="monthlyRent" type="number" step="0.01" placeholder="Monthly Rent" required /></div>
                <div class="mb-2"><input class="form-control" name="imageUrl" type="url" placeholder="Image URL" required /></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editHouseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="editHouseForm">
            <input type="hidden" name="id" id="edit-id" />
            <div class="modal-header">
                <h5 class="modal-title">Edit House</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2"><input class="form-control" name="name" id="edit-name" placeholder="Name" required /></div>
                <div class="mb-2"><input class="form-control" name="address" id="edit-address" placeholder="Address" required /></div>
                <div class="mb-2"><input class="form-control" name="description" id="edit-description" placeholder="Description" required /></div>
                <div class="mb-2"><input class="form-control" name="numberOfRooms" id="edit-rooms" type="number" placeholder="Rooms" required /></div>
                <div class="mb-2"><input class="form-control" name="monthlyRent" id="edit-rent" type="number" step="0.01" placeholder="Rent" required /></div>
                <div class="mb-2"><input class="form-control" name="imageUrl" id="edit-image" type="url" placeholder="Image URL" required /></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-warning">Update</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const token = localStorage.getItem("token");

    async function fetchHouses() {
        try {
            const res = await fetch("/api/management/houses", {
                headers: { Authorization: "Bearer " + token }
            });
            if (!res.ok) throw new Error("Unauthorized or error loading houses");
            const houses = await res.json();
            renderHouses(houses);
        } catch (err) {
            document.getElementById("houseContainer").innerHTML = `
                <div class="alert alert-danger">Failed to load houses. Please log in.</div>
            `;
        }
    }

    function renderHouses(houses) {
        const container = document.getElementById("houseContainer");
        container.innerHTML = "";
        houses.forEach((house) => {
            container.innerHTML += `
                <div class="col">
                    <a href="houseDetails.html?id=${house.id}" class="card-clickable">
                        <div class="card shadow-sm border-0 position-relative">
                            <div class="position-absolute top-0 start-0 bg-white p-1 px-2 rounded-end shadow-sm fw-semibold mt-2 ms-2 text-dark small">
                                Open: <span class="fw-bold">BEST NEAR UI!</span>
                            </div>
                            <img src="${house.imageUrl || "https://via.placeholder.com/400x250.png?text=No+Image"}"
                                 class="card-img-top" alt="House image">
                            <div class="card-body">
                                <p class="text-uppercase fw-bold text-muted small mb-1">${house.address}</p>
                                <h5 class="card-title mb-0 text-primary">${house.name}</h5>
                                <div class="mt-2">
                                    <h4 class="fw-bold mb-0 text-dark">Rp <span>${house.monthlyRent}</span></h4>
                                    <span class="badge bg-light text-dark border border-secondary fw-semibold small">NO FEE</span>
                                </div>
                                <div class="text-muted mt-1 small"><strong>${house.numberOfRooms} rooms</strong><br>12-month lease</div>
                                <div class="d-flex gap-3 mt-3 text-muted small">
                                    <div><i class="bi bi-house-heart-fill"></i> 1 Bed</div>
                                    <div><i class="bi bi-droplet-half"></i> 2 baths</div>
                                    <div><i class="bi bi-aspect-ratio-fill"></i> - m¬≤</div>
                                </div>
                                <div class="d-flex justify-content-between mt-3 action-buttons">
                                    <button class="btn btn-sm btn-warning"
                                            data-bs-toggle="modal" data-bs-target="#editHouseModal"
                                            data-id="${house.id}" data-name="${house.name}" data-address="${house.address}"
                                            data-description="${house.description}" data-rooms="${house.numberOfRooms}"
                                            data-rent="${house.monthlyRent}" data-image="${house.imageUrl}">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteHouse(${house.id})">
                                        ‚ùå Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>`;
        });
    }

    document.getElementById("createHouseForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));
        data.numberOfRooms = parseInt(data.numberOfRooms);
        data.monthlyRent = parseFloat(data.monthlyRent);

        await fetch("/api/management/houses", {
            method: "POST",
            headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
        });

        form.reset();
        bootstrap.Modal.getInstance(document.getElementById("createHouseModal")).hide();
        fetchHouses();
    });

    document.getElementById("editHouseModal").addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        document.getElementById("edit-id").value = button.getAttribute("data-id");
        document.getElementById("edit-name").value = button.getAttribute("data-name");
        document.getElementById("edit-address").value = button.getAttribute("data-address");
        document.getElementById("edit-description").value = button.getAttribute("data-description");
        document.getElementById("edit-rooms").value = button.getAttribute("data-rooms");
        document.getElementById("edit-rent").value = button.getAttribute("data-rent");
        document.getElementById("edit-image").value = button.getAttribute("data-image");
    });

    document.getElementById("editHouseForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const id = document.getElementById("edit-id").value;
        const data = Object.fromEntries(new FormData(form));
        data.numberOfRooms = parseInt(data.numberOfRooms);
        data.monthlyRent = parseFloat(data.monthlyRent);

        await fetch(`/api/management/houses/${id}`, {
            method: "PUT",
            headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
        });

        bootstrap.Modal.getInstance(document.getElementById("editHouseModal")).hide();
        fetchHouses();
    });

    async function deleteHouse(id) {
        if (!confirm("Are you sure you want to delete this house?")) return;
        await fetch(`/api/management/houses/${id}`, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token },
        });
        fetchHouses();
    }

    async function loadUserInfo() {
  const token = localStorage.getItem("token");
    if (!token) {
      document.getElementById("welcome-email").textContent = "Welcome, Guest";
      document.getElementById("wallet-balance").textContent = "0";
      return;
    }


  try {
    const res = await fetch("/api/auth/me", {
      headers: {
        Authorization: "Bearer " + token
      }
    });
    const user = await res.json();
    document.getElementById("welcome-email").textContent = `Welcome ${user.email} (UserID:${user.id})`;
    document.getElementById("wallet-balance").textContent = user.balance.toLocaleString("id-ID");
  } catch (err) {
    console.warn("Failed to load user info");
  }
}

window.addEventListener("DOMContentLoaded", () => {
  loadUserInfo();
  fetchHouses();
  setupNavbar();
});


function setupNavbar() {
  const token = localStorage.getItem("token");
  const loginBtn = document.getElementById("login-btn");
  const signupBtn = document.getElementById("signup-btn");
  const userDropdown = document.getElementById("user-dropdown");
  const userEmailSpan = document.getElementById("user-email");
  const logoutBtn = document.getElementById("logout-btn");

  if (!token) return;

  fetch("/api/auth/me", {
    headers: { Authorization: "Bearer " + token }
  })
    .then(res => res.json())
    .then(user => {
      userEmailSpan.textContent = user.email;
      loginBtn.style.display = "none";
      signupBtn.style.display = "none";
      userDropdown.style.display = "block";

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      });
    })
    .catch(() => console.warn("Failed to fetch user info for navbar"));
}
</script>
</body>
</html>
