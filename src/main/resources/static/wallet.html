<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

<main class="max-w-4xl mx-auto px-4 py-8 space-y-8">
    <!-- Back Button -->
    <a href="/management.html" class="inline-block text-sm text-blue-600 hover:underline">
        ‚Üê Back to My Houses
    </a>

    <!-- Wallet Overview -->
    <section class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold mb-4">My Wallet</h2>

        <div class="px-4 flex justify-between items-center">
            <div>
                üëã Welcome, <span id="welcome-email" class="font-semibold"></span>
                <br>
                üí∞ Balance: <span id="wallet-balance" class="text-green-700 font-bold">...</span>
            </div>
        </div>

        <!-- Top Up Section -->
        <div class="mt-6 mb-8">
            <h3 class="text-lg font-semibold mb-2">Top Up</h3>
            <form id="topup-form" class="flex flex-col gap-3">
                <input type="number" id="topup-amount" placeholder="Amount" min="1" class="border border-gray-300 px-3 py-2 rounded w-full md:w-48" required>
                <select id="topup-method" class="border border-gray-300 px-3 py-2 rounded w-full md:w-48">
                    <option value="bank">Bank Transfer</option>
                    <option value="virtual">Virtual Account</option>
                </select>
                <input type="password" id="topup-password" placeholder="Enter your password to confirm"
                       class="border border-gray-300 px-3 py-2 rounded w-full md:w-64 hidden" required>
                <button id="topup-confirm-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 hidden">Confirm Top Up</button>

                <p id="topup-msg" class="mt-2 text-sm"></p>
            </form>
        </div>

        <!-- Pay Rent Section -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-2">Pay Rent</h3>
            <form id="payrent-form" class="flex flex-col gap-3">
                <input type="text" id="pay-landlord" placeholder="Landlord ID" class="border border-gray-300 px-3 py-2 rounded w-full md:w-48" required>
                <input type="number" id="pay-amount" placeholder="Amount" min="1" class="border border-gray-300 px-3 py-2 rounded w-full md:w-48" required>
                <input type="password" id="pay-password" placeholder="Enter your password to confirm" class="border border-gray-300 px-3 py-2 rounded w-full md:w-64" required>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Pay Rent</button>
                <p id="payrent-msg" class="mt-2 text-sm"></p>
            </form>
        </div>
    </section>

    <!-- Transaction History -->
    <section class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-semibold mb-4">Transaction History</h3>
        <a href="/wallet-history.html" class="inline-block text-blue-600 hover:underline text-sm">
            ‚Üí View Full Transaction History
        </a>
    </section>
</main>

<script>
    let currentUserId = null;
    let token = localStorage.getItem("token");

    async function loadUserInfoAndBalance() {
        if (!token) {
            alert("Please login to use wallet features.");
            window.location.href = "/login.html";
            return;
        }
        try {
            const res = await fetch("/api/auth/users/me", {
                headers: { Authorization: "Bearer " + token }
            });
            if (!res.ok) throw new Error("Invalid session");
            const user = await res.json();
            currentUserId = user.id;
            document.getElementById("welcome-email").textContent = `${user.email || user.username} (ID: ${user.id})`;
            updateBalance(user.balance);
        } catch {
            alert("Session expired. Please log in again.");
            localStorage.removeItem("token");
            window.location.href = "/login.html";
        }
    }

    function updateBalance(balance) {
        const formatted = typeof balance === "number" && !isNaN(balance)
            ? "Rp " + balance.toLocaleString("id-ID")
            : "...";
        document.getElementById("wallet-balance").textContent = formatted;
    }

    function refreshBalance() {
        if (!currentUserId || !token) return;
        fetch(`/api/wallet/balance?userId=${currentUserId}`, {
            headers: { Authorization: "Bearer " + token }
        })
        .then(res => res.text())
        .then(balance => updateBalance(Number(balance)))
        .catch(() => {
            alert("Session expired. Please log in again.");
            localStorage.removeItem("token");
            window.location.href = "/login.html";
        });
    }

    // --- Top Up Logic ---
    const topupForm = document.getElementById("topup-form");
    const topupPassword = document.getElementById("topup-password");
    const topupConfirmBtn = document.getElementById("topup-confirm-btn");
    const topupMsg = document.getElementById("topup-msg");

    // Hide password and confirm button initially
    topupPassword.classList.add("hidden");
    topupConfirmBtn.classList.add("hidden");

    // Show password and confirm button when amount and method are filled and user presses Enter or changes input
    topupForm.addEventListener("input", function () {
        const amount = document.getElementById("topup-amount").value;
        const method = document.getElementById("topup-method").value;
        if (amount && method) {
            topupPassword.classList.remove("hidden");
            topupConfirmBtn.classList.remove("hidden");
        } else {
            topupPassword.classList.add("hidden");
            topupConfirmBtn.classList.add("hidden");
        }
    });

    topupForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById("topup-amount").value);
        const method = document.getElementById("topup-method").value;
        const password = topupPassword.value;
        topupMsg.textContent = "";

        if (!currentUserId || isNaN(amount) || amount <= 0 || !password) {
            topupMsg.textContent = "Please complete all fields.";
            topupMsg.className = "text-red-600 mt-2 font-semibold";
            return;
        }

        try {
            const res = await fetch("/api/wallet/topup", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({
                    userId: currentUserId,
                    amount: amount,
                    method: method,
                    password: password
                })
            });

            const data = await res.json();
            if (data.status === "SUCCESS") {
                alert("Top up successful!");
                refreshBalance();
                topupForm.reset();
                topupPassword.classList.add("hidden");
                topupConfirmBtn.classList.add("hidden");
                topupMsg.textContent = "";
            } else {
                topupMsg.textContent = data.message || "Top up failed. Please try again.";
                topupMsg.className = "text-red-600 mt-2 font-semibold";
            }
        } catch (err) {
            topupMsg.textContent = "Top up failed. Please try again.";
            topupMsg.className = "text-red-600 mt-2 font-semibold";
        }
    });

    // --- Pay Rent Logic ---
    const payrentForm = document.getElementById("payrent-form");
    const payPassword = document.getElementById("pay-password");
    const payrentMsg = document.getElementById("payrent-msg");

    // Hide password initially
    payPassword.classList.add("hidden");

    payrentForm.addEventListener("input", function () {
        const landlord = document.getElementById("pay-landlord").value;
        const amount = document.getElementById("pay-amount").value;
        if (landlord && amount) {
            payPassword.classList.remove("hidden");
        } else {
            payPassword.classList.add("hidden");
        }
    });

    payrentForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const landlordId = document.getElementById("pay-landlord").value;
        const amount = parseFloat(document.getElementById("pay-amount").value);
        const password = payPassword.value;
        payrentMsg.textContent = "";

        if (!currentUserId || !landlordId || isNaN(amount) || amount <= 0 || !password) {
            payrentMsg.textContent = "Please complete all fields.";
            payrentMsg.className = "text-red-600 mt-2 font-semibold";
            return;
        }

        try {
            const res = await fetch("/api/wallet/payrent", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({
                    userId: currentUserId,
                    landlordId: landlordId,
                    amount: amount,
                    password: password
                })
            });

            if (res.status === 401) {
                alert("Session expired. Please log in again.");
                localStorage.removeItem("token");
                window.location.href = "/login.html";
                return;
            }

            const data = await res.json();
            if (data.status === "SUCCESS") {
                alert("Payment successful!");
                refreshBalance();
                payrentForm.reset();
                payPassword.classList.add("hidden");
                payrentMsg.textContent = "";
            } else {
                payrentMsg.textContent = data.message || "Payment failed. Please try again.";
                payrentMsg.className = "text-red-600 mt-2 font-semibold";
            }
        } catch (err) {
            payrentMsg.textContent = "Payment failed. Please try again.";
            payrentMsg.className = "text-red-600 mt-2 font-semibold";
        }
    });

    window.addEventListener("DOMContentLoaded", loadUserInfoAndBalance);
</script>
</body>
</html>
