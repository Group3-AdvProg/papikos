<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>My Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

<main class="max-w-4xl mx-auto px-4 py-8 space-y-8">
    <a href="management.html" class="inline-block text-sm text-blue-600 hover:underline">
        ‚Üê Back to My Houses
    </a>

    <section class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold mb-4">My Wallet</h2>
        <div class="px-4 flex justify-between items-center mb-6">
            <div>
                üëã Welcome, <span id="welcome-email" class="font-semibold"></span><br />
                üí∞ Balance: <span id="wallet-balance" class="text-green-700 font-bold">...</span>
            </div>
        </div>

        <!-- Top Up Section -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-2">Top Up</h3>
            <div id="topup-section" class="flex flex-col gap-3">
                <label for="topup-amount"></label><input type="number" id="topup-amount" placeholder="Amount" min="1"
                                                         class="border px-3 py-2 rounded w-full md:w-48" />
                <label for="topup-method"></label><select id="topup-method" class="border px-3 py-2 rounded w-full md:w-48">
                    <option value="bank">Bank Transfer</option>
                    <option value="virtual">Virtual Account</option>
                </select>
                <button type="button" id="topup-btn"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Top Up
                </button>
                <p id="topup-msg" class="mt-2 text-sm text-red-600"></p>
            </div>
        </div>

        <!-- Pay Rent Section -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-2">Pay Rent</h3>
            <div id="payrent-section" class="flex flex-col gap-3">
                <label for="pay-landlord"></label><input type="text" id="pay-landlord" placeholder="Landlord ID"
                                                         class="border px-3 py-2 rounded w-full md:w-48" />
                <label for="pay-amount"></label><input type="number" id="pay-amount" placeholder="Amount" min="1"
                                                       class="border px-3 py-2 rounded w-full md:w-48" />
                <button type="button" id="pay-btn"
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    Pay Rent
                </button>
                <p id="pay-msg" class="mt-2 text-sm text-red-600"></p>
            </div>
        </div>
    </section>

    <section class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-semibold mb-4">Transaction History</h3>
        <a href="wallet-history.html" class="inline-block text-blue-600 hover:underline text-sm">
            ‚Üí View Full Transaction History
        </a>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/navbarLoader.js"></script>
<script>
    window.addEventListener("DOMContentLoaded", () => {
      const token = sessionStorage.getItem("token");
      if (!token) return redirectToLogin();

      // Load user profile and balance
      async function loadProfile() {
        try {
          const res = await fetch("/api/auth/users/me", {
            headers: { "Authorization": "Bearer " + token }
          });
          if (!res.ok) throw new Error();
          const user = await res.json();
          document.getElementById("welcome-email").textContent = `${user.email} (ID: ${user.id})`;
          document.getElementById("wallet-balance").textContent =
            "Rp " + Number(user.balance).toLocaleString("id-ID");
        } catch {
          redirectToLogin();
        }
      }

      // Redirect to login on auth failure
      function redirectToLogin() {
        alert("Session expired. Please log in again.");
        sessionStorage.removeItem("token");
        window.location.href = "/login.html";
      }

      // Top-Up logic
      function bindTopUp() {
        const btn = document.getElementById("topup-btn");
        const msg = document.getElementById("topup-msg");
        let inProgress = false;

        btn.addEventListener("click", async () => {
          if (inProgress) return;
          inProgress = true;
          msg.textContent = "";

          const amount = parseFloat(document.getElementById("topup-amount").value);
          const method = document.getElementById("topup-method").value;
          if (isNaN(amount) || amount <= 0) {
            msg.textContent = "Enter a valid amount.";
            inProgress = false;
            return;
          }
          if (!confirm(`Top up Rp ${amount.toLocaleString("id-ID")} via ${method}?`)) {
            inProgress = false;
            return;
          }

          btn.disabled = true;
          btn.innerText = "Processing...";

          try {
            const res = await fetch("/api/wallet/topup", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
              },
              body: JSON.stringify({ amount, method })
            });
            if (res.status === 401) return redirectToLogin();

            const { status, message } = await res.json();
            if (status === "SUCCESS") {
              alert("Top-up successful!");
              await loadProfile();
              document.getElementById("topup-amount").value = "";
            } else {
              msg.textContent = message || "Top-up failed.";
            }
          } catch {
            msg.textContent = "Network error.";
          } finally {
            btn.disabled = false;
            btn.innerText = "Top Up";
            inProgress = false;
          }
        });
      }

      // Pay-Rent logic
      function bindPayRent() {
        const btn = document.getElementById("pay-btn");
        const msg = document.getElementById("pay-msg");
        let inProgress = false;

        btn.addEventListener("click", async () => {
          if (inProgress) return;
          inProgress = true;
          msg.textContent = "";

          const landlordId = document.getElementById("pay-landlord").value.trim();
          const amount = parseFloat(document.getElementById("pay-amount").value);
          if (!landlordId || isNaN(amount) || amount <= 0) {
            msg.textContent = "Complete all fields.";
            inProgress = false;
            return;
          }
          if (!confirm(`Pay Rp ${amount.toLocaleString("id-ID")} to landlord ${landlordId}?`)) {
            inProgress = false;
            return;
          }

          btn.disabled = true;
          btn.innerText = "Processing...";

          try {
            const res = await fetch("/api/wallet/pay-rent", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
              },
              body: JSON.stringify({ targetId: landlordId, amount })
            });
            if (res.status === 401) return redirectToLogin();

            const { status, message } = await res.json();
            if (status === "SUCCESS") {
              alert("Payment successful!");
              await loadProfile();
              document.getElementById("pay-landlord").value = "";
              document.getElementById("pay-amount").value = "";
            } else {
              msg.textContent = message || "Payment failed.";
            }
          } catch {
            msg.textContent = "Network error.";
          } finally {
            btn.disabled = false;
            btn.innerText = "Pay Rent";
            inProgress = false;
          }
        });
      }

      // Navbar loader (if you have this function)
      if (typeof loadNavbar === "function") {
        loadNavbar();
      }

      // Initialize everything
      loadProfile();
      bindTopUp();
      bindPayRent();
    });
</script>
</body>
</html>