<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rental Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        :root {
            --bs-primary: #7065F0;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f9f9ff;
        }
        .navbar {
            background-color: var(--bs-primary);
        }
        .navbar a, .navbar-brand {
            color: white;
        }
        .navbar a:hover {
            color: #ddd;
        }
        .section-title {
            margin: 2rem 0 1rem;
            color: var(--bs-primary);
        }
        .data-table th {
            background-color: var(--bs-primary);
            color: white;
        }
        .data-table td, .data-table th {
            padding: 0.75rem;
            text-align: center;
        }
        .data-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .action-btn {
            margin: 0 2px;
        }
        #searchInput {
            max-width: 300px;
            margin-bottom: 1rem;
        }
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1055;
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">PapiKos</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link text-white" href="/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link text-white active" href="/rental">Rental</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="/logout">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Toast Alert -->
<div class="toast-container">
    <div id="rentalToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">Rental berhasil ditambahkan!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Konten utama -->
<main class="container mt-4">
    <h1 class="section-title">Add New Rental</h1>
    <form id="rentalForm" class="row g-3 mb-5">
        <div class="col-md-6">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-control" id="fullName" required>
        </div>
        <div class="col-md-6">
            <label class="form-label">Phone Number</label>
            <input type="text" class="form-control" id="phoneNumber" required>
        </div>
        <div class="col-md-4">
            <label class="form-label">House ID</label>
            <input type="text" class="form-control" id="houseId" required>
        </div>
        <div class="col-md-4">
            <label class="form-label">Check-in Date</label>
            <input type="date" class="form-control" id="checkInDate" required>
        </div>
        <div class="col-md-4">
            <label class="form-label">Duration (months)</label>
            <input type="number" class="form-control" id="duration" min="1" required>
        </div>
        <div class="col-12 d-flex justify-content-between">
            <button type="reset" class="btn btn-secondary">Reset</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">Submit Rental</button>
        </div>
    </form>

    <h1 class="section-title">Rental List</h1>
    <input type="text" class="form-control" id="searchInput" placeholder="Search by Full Name..." />

    <div class="table-responsive">
        <table class="table table-bordered data-table">
            <thead>
            <tr>
                <th>Full Name</th>
                <th>Phone</th>
                <th>House ID</th>
                <th>Check-in</th>
                <th>Duration</th>
                <th>Total Price</th>
                <th>Paid</th>
                <th>Approved</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="rentalTableBody"></tbody>
        </table>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const PRICE_PER_MONTH = 1000000;
    let rentalData = [];

    function formatCurrency(value) {
        return 'Rp' + value.toLocaleString('id-ID');
    }

    function updateRental(id, payload) {
        const buttons = document.querySelectorAll(`button[data-id='${id}']`);
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        });

        fetch(`/api/rentals/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(res => res.ok ? window.location.reload() : Promise.reject('Update failed'))
            .catch(err => {
                alert(err);
                buttons.forEach(btn => btn.disabled = false);
            });
    }

    function renderTable(data) {
        const table = document.getElementById('rentalTableBody');
        table.innerHTML = '';
        data.forEach(rental => {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${rental.fullName}</td>
                    <td>${rental.phoneNumber}</td>
                    <td>${rental.houseId}</td>
                    <td>${rental.checkInDate}</td>
                    <td>${rental.durationInMonths}</td>
                    <td>${formatCurrency(rental.totalPrice)}</td>
                    <td>${rental.paid ? 'Yes' : 'No'}</td>
                    <td>${rental.approved ? 'Yes' : 'No'}</td>
                    <td>
                        <button class="btn btn-success btn-sm action-btn" data-id="${rental.id}" onclick='updateRental("${rental.id}", {...rental, approved: true})'>Approve</button>
                        <button class="btn btn-warning btn-sm action-btn" data-id="${rental.id}" onclick='updateRental("${rental.id}", {...rental, paid: !rental.paid})'>Toggle Paid</button>
                    </td>
                `;
            table.appendChild(row);
        });
    }

    fetch('/api/rentals')
        .then(res => res.json())
        .then(data => {
            rentalData = data;
            renderTable(data);
        });

    document.getElementById('rentalForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = 'Submitting...';

        const duration = parseInt(document.getElementById('duration').value);
        if (duration <= 0) {
            alert('Duration must be more than 0!');
            btn.disabled = false;
            btn.textContent = 'Submit Rental';
            return;
        }

        const payload = {
            fullName: document.getElementById('fullName').value,
            phoneNumber: document.getElementById('phoneNumber').value,
            houseId: document.getElementById('houseId').value,
            checkInDate: document.getElementById('checkInDate').value,
            durationInMonths: duration,
            approved: false,
            paid: false,
            totalPrice: duration * PRICE_PER_MONTH
        };

        fetch('/api/rentals', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(res => res.ok ? res.json() : Promise.reject('Gagal menambah rental'))
            .then(() => {
                const toast = new bootstrap.Toast(document.getElementById('rentalToast'));
                toast.show();
                btn.disabled = false;
                btn.textContent = 'Submit Rental';
                setTimeout(() => window.location.reload(), 2000);
            })
            .catch(err => {
                alert(err);
                btn.disabled = false;
                btn.textContent = 'Submit Rental';
            });
    });

    document.getElementById('searchInput').addEventListener('input', e => {
        const keyword = e.target.value.toLowerCase();
        const filtered = rentalData.filter(r => r.fullName.toLowerCase().includes(keyword));
        renderTable(filtered);
    });
</script>
</body>
</html>
