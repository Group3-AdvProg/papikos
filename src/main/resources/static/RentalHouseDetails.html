<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>House Detail</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
            rel="stylesheet"
    />
    <style>
        :root { --bs-primary: #7065F0; }
        body  { font-family: 'Segoe UI', sans-serif; background: #f9f9ff; }
        .navbar { background: var(--bs-primary); }
        .navbar a, .navbar-brand { color: #fff; }
        .navbar a:hover { color: #ddd; }
    </style>
</head>
<body>
<div id="navbar-placeholder"></div>

<div class="container py-4">
    <div id="detailArea" class="row justify-content-center"></div>
    <a class="btn btn-outline-secondary mt-4" href="/rental.html">⬅ Back to list</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/navbarLoader.js"></script>
<script>
    const token      = sessionStorage.getItem("token");
    const houseId    = new URLSearchParams(location.search).get("houseId");
    let currentUser  = null;
    let currentHouse = null;
    let houseOwner   = null;

    document.addEventListener("DOMContentLoaded", async () => {
        if (!token) return location.href = "/login.html";

        // 1) Get the current user and ensure they’re a tenant
        const meResp = await fetch("/api/auth/users/me", {
            headers: { Authorization: `Bearer ${token}` }
        });
        const me = await meResp.json();
        if (!me.role?.includes("TENANT")) return location.href = "/login.html";
        currentUser = me;

        // 2) Load the house data
        await loadHouse();
    });

    async function loadHouse() {
        try {
            const res = await fetch(`/api/houses/${houseId}`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            if (!res.ok) throw new Error("House fetch failed");
            currentHouse = await res.json();
            houseOwner   = currentHouse.owner || null;
            render();
        } catch (e) {
            document.getElementById("detailArea").innerHTML =
                `<div class="alert alert-danger">Failed to load house.</div>`;
        }
    }

    function render() {
        const h     = currentHouse;
        const addr  = h.location ?? h.address ?? "-";
        const price = (h.monthlyRent ?? h.price ?? 0).toLocaleString("id-ID");
        const rooms = h.numberOfRooms ?? "-";
        const img   = h.imageUrl || "https://via.placeholder.com/600x350.png?text=No+Image";

        const ownerBlock = houseOwner
            ? `
        <div class="card mb-4">
          <div class="card-header bg-light fw-semibold">Owner Details</div>
          <div class="card-body">
            <p class="mb-1"><strong>Name:</strong> ${houseOwner.fullName}</p>
            <p class="mb-1"><strong>Phone:</strong> ${houseOwner.phoneNumber}</p>
            <p class="mb-0"><strong>Email:</strong> ${houseOwner.email}</p>
          </div>
        </div>
      `
            : `<div class="alert alert-warning">Owner info not available.</div>`;

        // Only show the chat button if you’re NOT the landlord
        const showChatBtn = houseOwner && currentUser.id !== houseOwner.id
            ? `<button
           class="btn btn-outline-primary w-100 mb-2"
           onclick="contactLandlord()"
         >
           <i class="bi bi-chat-dots-fill"></i> Chat with Landlord
         </button>`
            : "";

        document.getElementById("detailArea").innerHTML = `
      <div class="col-md-8">
        ${ownerBlock}
        <div class="card shadow-sm border-0">
          <img src="${img}" class="card-img-top" alt="house" />
          <div class="card-body">
            <p class="text-uppercase fw-bold text-muted small mb-1">${addr}</p>
            <h3 class="text-primary fw-bold">${h.name}</h3>
            <h4 class="fw-bold mt-3">Rp ${price}</h4>
            <div class="text-muted small mb-3">${rooms} rooms</div>
            <p>${h.description ?? "-"}</p>

            ${showChatBtn}

            <label for="checkInDate" class="form-label fw-semibold">Check-in Date</label>
            <input type="date" id="checkInDate" class="form-control w-25 mb-3" required />

            <label for="duration" class="form-label fw-semibold">Duration (months)</label>
            <input type="number" id="duration" class="form-control w-25 mb-3"
                   value="1" min="1" required />

            <button class="btn btn-primary w-100" onclick="bookNow()">Book Now</button>
          </div>
        </div>
      </div>
    `;
    }

    async function contactLandlord() {
        if (!houseOwner) return alert("Owner info not available.");
        try {
            const res = await fetch("/api/chat/rooms", {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ landlordEmail: houseOwner.email })
            });
            if (!res.ok) throw new Error("Could not start chat");
            const room = await res.json();
            window.location.href = `/chat.html?roomId=${room.id}`;
        } catch (e) {
            alert("Error starting chat: " + e.message);
        }
    }

    async function bookNow() {
        const checkIn  = document.getElementById("checkInDate").value;
        const duration = +document.getElementById("duration").value;

        if (!checkIn) return alert("Please choose a check-in date!");
        if (duration < 1) return alert("Duration must be at least 1 month!");

        const baseRent = currentHouse.monthlyRent ?? currentHouse.price ?? 0;
        const totalCost = baseRent * duration;

        const payload = {
            houseId: currentHouse.id,
            tenantId: currentUser.id,
            checkInDate: checkIn,
            durationInMonths: duration,
            totalPrice: totalCost,
            isPaid: false
        };

        try {
            const res = await fetch("/api/rentals", {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                alert("Booking berhasil!");
                location.href = `/rentalRequests.html?houseId=${currentHouse.id}`;
            } else {
                const err = await res.text();
                alert("Gagal booking: " + err);
            }
        } catch (e) {
            alert("Booking error: " + e.message);
        }
    }

    window.addEventListener("DOMContentLoaded", () => {
        loadNavbar();
    });
</script>
</body>
</html>