<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wallet Transaction History</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

<!-- Header -->
<header class="bg-blue-100 border border-blue-300 py-4 shadow-sm">
    <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
        <div>
            üßæ <span class="font-semibold">Transaction History</span>
        </div>
        <a href="/wallet.html" class="text-sm text-blue-600 hover:underline">‚Üê Back to Wallet</a>
    </div>
</header>

<!-- Main Content -->
<main class="max-w-4xl mx-auto px-4 py-8">
    <!-- Filter Form -->
    <form id="filter-form" class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-6">
        <select id="type" class="border border-gray-300 px-3 py-2 rounded">
            <option value="">All Types</option>
            <option value="TOP_UP">Top-Up</option>
            <option value="RENT_PAYMENT">Rent Payment</option>
        </select>
        <input type="date" id="from" class="border border-gray-300 px-3 py-2 rounded" />
        <input type="date" id="to" class="border border-gray-300 px-3 py-2 rounded" />
        <select id="sort" class="border border-gray-300 px-3 py-2 rounded">
            <option value="latest">Latest</option>
            <option value="earliest">Earliest</option>
            <option value="amount-most">Amount (Most)</option>
            <option value="amount-least">Amount (Least)</option>
        </select>
        <select id="direction-filter" class="border border-gray-300 px-3 py-2 rounded">
            <option value="all">All Directions</option>
            <option value="incoming">Incoming</option>
            <option value="outgoing">Outgoing</option>
        </select>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Filter</button>
    </form>

    <!-- Results -->
    <div id="results" class="space-y-3 text-sm"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/navbarLoader.js"></script>
<script>
    let token = sessionStorage.getItem("token");
    let currentUserId = null;
    let lastTransactions = [];

    async function loadUser() {
      if (!token) {
        alert("Please log in.");
        window.location.href = "/login.html";
        return;
      }

      try {
        const res = await fetch("/api/auth/users/me", {
          headers: { Authorization: "Bearer " + token }
        });

        if (!res.ok) throw new Error("Unauthorized");
        const user = await res.json();
        currentUserId = user.id;
        fetchAndRenderTransactions(`/api/transaction/user/${currentUserId}`);
      } catch {
        alert("Session expired. Please log in again.");
        sessionStorage.removeItem("token");
        window.location.href = "/login.html";
      }
    }

    function sortTransactions(transactions, sortBy) {
      const sorted = [...transactions];
      switch (sortBy) {
        case "earliest":
          sorted.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          break;
        case "latest":
          sorted.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          break;
        case "amount-most":
          sorted.sort((a, b) => Number(b.amount) - Number(a.amount));
          break;
        case "amount-least":
          sorted.sort((a, b) => Number(a.amount) - Number(b.amount));
          break;
        default:
          // Default to latest
          sorted.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      }
      return sorted;
    }

    async function fetchAndRenderTransactions(url) {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "Loading...";
      try {
        const res = await fetch(url, {
          headers: { Authorization: "Bearer " + token }
        });

        if (res.status === 401) {
          alert("Session expired. Please log in again.");
          sessionStorage.removeItem("token");
          window.location.href = "/login.html";
          return;
        }

        if (!res.ok) throw new Error("Failed to fetch");

        let transactions = await res.json();
        if (!Array.isArray(transactions)) transactions = [transactions];

        lastTransactions = transactions; // Save for sorting

        renderTransactions();
      } catch {
        resultsDiv.innerHTML = `<p class="text-red-500">Failed to load transactions.</p>`;
      }
    }

    function renderTransactions() {
      const resultsDiv = document.getElementById("results");
      const sortBy = document.getElementById("sort")?.value || "latest";
      const directionFilter = document.getElementById("direction-filter")?.value || "all";
      let transactions = sortTransactions(lastTransactions, sortBy);

      if (directionFilter !== "all") {
        transactions = transactions.filter(tx => {
          let direction = "-";
          if (tx.type === "TOP_UP") {
            direction = "incoming";
          } else if (tx.targetUser && currentUserId) {
            direction = String(tx.targetUser.id) === String(currentUserId) ? "incoming" : "outgoing";
          }
          return direction === directionFilter;
        });
      }

      if (!transactions.length) {
        resultsDiv.innerHTML = `<p class="text-gray-500">No transactions found.</p>`;
        return;
      }

      resultsDiv.innerHTML = transactions.map(tx => {
        // Determine incoming/outgoing
        let direction = "-";
        if (tx.type === "TOP_UP") {
          direction = "Incoming";
        } else if (tx.targetUser && currentUserId) {
          direction = String(tx.targetUser.id) === String(currentUserId) ? "Incoming" : "Outgoing";
        }

        // Determine from/to display
        let fromTo = "";
        if (tx.type === "TOP_UP") {
          fromTo = `From <span class="font-semibold">System</span> to <span class="font-semibold">${tx.user?.fullName || tx.user?.username || "You"}</span>`;
        } else if (tx.user && tx.targetUser) {
          fromTo = `From <span class="font-semibold">${tx.user.fullName || tx.user.username || "User"}</span> to <span class="font-semibold">${tx.targetUser.fullName || tx.targetUser.username || "User"}</span>`;
        }

        return `
        <div class="border p-3 rounded bg-gray-50">
          <div class="flex justify-between items-center">
            <strong>${tx.type || "?"}</strong>
            <span class="text-xs text-gray-600">ID: ${tx.id || "-"}</span>
          </div>
          <div>
            Rp ${Number(tx.amount || 0).toLocaleString('id-ID')} via ${tx.method || "-"}
            <br>
            <span class="text-xs">${fromTo}</span>
            <br>
            <span class="text-xs text-gray-500">${tx.timestamp ? new Date(tx.timestamp).toLocaleString("id-ID") : ""}</span>
            <br>
            <span class="text-xs ${direction === "Outgoing" ? "text-red-500" : "text-green-600"} font-semibold">${direction}</span>
          </div>
        </div>
        `;
      }).join("");
    }

    async function loadMiniTransactions() {
        if (!currentUserId || !token) return;
        const res = await fetch(`/api/transaction/user-or-target/${currentUserId}`, {
            headers: { Authorization: "Bearer " + token }
        });
        if (!res.ok) return;
        const txs = await res.json();
        window._allMiniTxs = txs; // cache for filtering
        renderMiniTransactions();
    }

    function renderMiniTransactions() {
        const txs = window._allMiniTxs || [];
        const filter = document.getElementById("direction-filter").value;
        const filtered = txs.filter(tx => {
            if (filter === "all") return true;
            let direction = "-";
            if (tx.type === "TOP_UP") direction = "incoming";
            else if (tx.targetUser && currentUserId) {
                direction = String(tx.targetUser.id) === String(currentUserId) ? "incoming" : "outgoing";
            }
            return direction === filter;
        });
        const miniDiv = document.getElementById("mini-transactions");
        if (!filtered.length) {
            miniDiv.innerHTML = `<p class="text-gray-500 text-sm">No transactions found.</p>`;
            return;
        }
        miniDiv.innerHTML = filtered.slice(0, 5).map(tx => {
            let direction = "-";
            if (tx.type === "TOP_UP") direction = "incoming";
            else if (tx.targetUser && currentUserId) {
                direction = String(tx.targetUser.id) === String(currentUserId) ? "incoming" : "outgoing";
            }
            return `
            <div class="border p-2 rounded bg-gray-50 flex justify-between items-center">
                <span>
                    <strong>${tx.type || "?"}</strong>
                    <span class="text-xs text-gray-600">ID: ${tx.id || "-"}</span>
                    <br>
                    Rp ${Number(tx.amount || 0).toLocaleString('id-ID')}
                </span>
                <span class="text-xs ${direction === "outgoing" ? "text-red-500" : "text-green-600"} font-semibold">
                    ${direction.charAt(0).toUpperCase() + direction.slice(1)}
                </span>
            </div>
            `;
        }).join("");
    }

    function filterTransactions() {
      const type = document.getElementById("type").value;
      const from = document.getElementById("from").value;
      const to = document.getElementById("to").value;
      if (!currentUserId) return;

      let url = `/api/transaction/user/${currentUserId}`;
      if (type && from && to) {
        url = `/api/transaction/filter?userId=${currentUserId}&type=${type}&from=${from}T00:00:00&to=${to}T23:59:59`;
      } else if (type) {
        url = `/api/transaction/type?userId=${currentUserId}&type=${type}`;
      } else if (from && to) {
        url = `/api/transaction/date?userId=${currentUserId}&from=${from}T00:00:00&to=${to}T23:59:59`;
      }

      fetchAndRenderTransactions(url);
    }

    const filterForm = document.getElementById("filter-form");
    if (filterForm) {
      filterForm.addEventListener("submit", function (e) {
        e.preventDefault();
        filterTransactions();
      });

      // Re-render transactions when sort dropdown changes
      document.getElementById("sort").addEventListener("change", renderTransactions);
    }

    document.getElementById("direction-filter").addEventListener("change", renderMiniTransactions);

    window.addEventListener("DOMContentLoaded", () => {
        loadNavbar();
        loadUser();
        loadMiniTransactions();
    });
</script>
</body>
</html>
